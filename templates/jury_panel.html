<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>RKSIBET — Панель Жюри</title>
<link rel="stylesheet" href="{{ url_for('static', filename='css/juri_panel.css') }}">
</head>
<body>
<header>
  <div>Жюри: {{ jury.name }}</div>
  <a href="{{ url_for('home') }}">[Выход]</a>
</header>

<div class="container">
<div class="sidebar">
    <p>Вы можете редактировать только свою колонку (подсвечена).</p>
    <p><strong style="color: #ff3366;">Важно:</strong> После выставления баллов нажмите "Финализировать". Изменить будет нельзя!</p>
    <p>Следите за суммой ваших баллов и за обновлениями в реальном времени.</p>
    <p><strong style="color: #ff3366;">Важно:</strong> После перехода на лидерборд, чтобы вернуться обратно к панели жюри, придется заново войти</p>
  <h3 style="margin-top:20px;"><a href="{{ url_for('leaderboard') }}" id="lead">Перейти к Лидерборду</a></h3>
</div>

<div class="main">
<h3 style="color: #527C8C;">Оценки участников</h3>
<table id="score-table">
<tr>
  <th style="color: #527C8C;">Участник</th>
  {% for j in jury_list %}
    <th class="{% if j.id == jury.id %}my-column{% endif %}">{{ j.name }}</th>
  {% endfor %}
  <th>Сумма</th>
</tr>

{% for p in participants %}
<tr id="row-{{ p.id }}">
  <td>{{ p.name }}</td>
  {% for j in jury_list %}
  <td id="cell-{{ p.id }}-{{ j.id }}" class="{% if j.id == jury.id %}my-column{% endif %}">
    {% if j.id == jury.id %}
      <div class="score-inputs" id="inputs-{{ p.id }}-{{ j.id }}">
        <input type="number" min="0" max="5" value="{{ scores[p.id][j.id]['contest1'] }}"
               class="score-input" data-participant="{{ p.id }}" data-jury="{{ j.id }}" data-contest="contest1"
               {% if scores[p.id][j.id]['finalized'] %}disabled{% endif %}>
        <input type="number" min="0" max="5" value="{{ scores[p.id][j.id]['contest2'] }}"
               class="score-input" data-participant="{{ p.id }}" data-jury="{{ j.id }}" data-contest="contest2"
               {% if scores[p.id][j.id]['finalized'] %}disabled{% endif %}>
        <input type="number" min="0" max="5" value="{{ scores[p.id][j.id]['contest3'] }}"
               class="score-input" data-participant="{{ p.id }}" data-jury="{{ j.id }}" data-contest="contest3"
               {% if scores[p.id][j.id]['finalized'] %}disabled{% endif %}>
      </div>
      <div class="total-score" id="display-{{ p.id }}-{{ j.id }}">
        {{ scores[p.id][j.id]['contest1'] }}+{{ scores[p.id][j.id]['contest2'] }}+{{ scores[p.id][j.id]['contest3'] }}
      </div>
      <div class="finalize-section" id="finalize-{{ p.id }}-{{ j.id }}">
        {% if not scores[p.id][j.id]['finalized'] %}
        <button class="finalize-btn" data-participant="{{ p.id }}" data-jury="{{ j.id }}">Финализировать</button>
        {% else %}
        <span class="finalized-text">✓ Финализировано</span>
        {% endif %}
      </div>
    {% else %}
      <div class="jury-score" style="color: #527C8C;">
        <div>Конкурс 1: {{ scores[p.id][j.id]['contest1'] }} баллов</div>
        <div>Конкурс 2: {{ scores[p.id][j.id]['contest2'] }} баллов</div>
        <div>Конкурс 3: {{ scores[p.id][j.id]['contest3'] }} баллов</div>
        <div class="total-score">Сумма: {{ scores[p.id][j.id]['contest1'] + scores[p.id][j.id]['contest2'] + scores[p.id][j.id]['contest3'] }}</div>
      </div>
    {% endif %}
  </td>
  {% endfor %}

  <td id="total-{{ p.id }}">
    <div class="participant-scores">
      <div class="total-score">Общая сумма: {{ totals[p.id] }}</div>
      {% set my_total = scores[p.id][jury.id]['contest1'] + scores[p.id][jury.id]['contest2'] + scores[p.id][jury.id]['contest3'] %}
      {% if my_total > 0 %}
      <div class="my-total">Мои баллы: {{ my_total }}</div>
      {% endif %}
      <div class="all-scores">
        {% for j in jury_list %}
        <div class="jury-score"><strong>{{ j.name }}:</strong>
          {{ scores[p.id][j.id]['contest1'] + scores[p.id][j.id]['contest2'] + scores[p.id][j.id]['contest3'] }}
          {% if scores[p.id][j.id]['finalized'] %}<span class="finalized-text">✓</span>{% endif %}
        </div>
        {% endfor %}
      </div>
    </div>
  </td>
</tr>
{% endfor %}
</table>
</div>
</div>

<script>
let ws;
function connectWebSocket() {
    ws = new WebSocket("ws://"+location.host+"/ws");

    ws.onopen = ()=>console.log("WebSocket connected");
    ws.onclose = ()=>setTimeout(connectWebSocket,1000);
    ws.onerror = (e)=>console.log("WebSocket error:",e);
    ws.onmessage = handleMessage;
}
connectWebSocket();

function handleMessage(event){
    let data=JSON.parse(event.data);
    if(data.type==='score_update'){
        for(let p_id in data.scores){
            for(let j_id in data.scores[p_id]){
                let cell=document.getElementById(`cell-${p_id}-${j_id}`);
                if(cell){
                    let vals=data.scores[p_id][j_id];
                    let total=vals.contest1+vals.contest2+vals.contest3;

                    if(cell.classList.contains('my-column')){
                        let inputs = cell.querySelectorAll('.score-input');
                        if(inputs.length>=3){
                            inputs[0].value=vals.contest1;
                            inputs[1].value=vals.contest2;
                            inputs[2].value=vals.contest3;
                            if(vals.finalized){
                                inputs.forEach(i=>i.disabled=true);
                                let finalize=document.getElementById(`finalize-${p_id}-${j_id}`);
                                if(finalize) finalize.innerHTML='<span class="finalized-text">✓ Финализировано</span>';
                            }
                        }
                        let display=document.getElementById(`display-${p_id}-${j_id}`);
                        if(display){display.textContent=`${vals.contest1}+${vals.contest2}+${vals.contest3}`; display.classList.add('highlight'); setTimeout(()=>display.classList.remove('highlight'),500);}
                    } else {
                        cell.innerHTML=`
                          <div class="jury-score">
                            <div>Конкурс 1: ${vals.contest1} баллов</div>
                            <div>Конкурс 2: ${vals.contest2} баллов</div>
                            <div>Конкурс 3: ${vals.contest3} баллов</div>
                            <div class="total-score">Сумма: ${total}</div>
                          </div>`;
                        cell.classList.add('highlight'); setTimeout(()=>cell.classList.remove('highlight'),500);
                    }
                }
            }
            let totalCell=document.getElementById(`total-${p_id}`);
            if(totalCell){
                let part=totalCell.querySelector('.participant-scores');
                if(part){
                    let totalSum=part.querySelector('.total-score');
                    if(totalSum) totalSum.textContent=`Общая сумма: ${data.totals[p_id]}`;
                    let allScores=part.querySelector('.all-scores');
                    if(allScores){
                        allScores.innerHTML='';
                        let juryNames={};
                        if(data.jury_list) data.jury_list.forEach(j=>juryNames[j.id]=j.name);
                        for(let j_id in data.scores[p_id]){
                            let j_vals=data.scores[p_id][j_id];
                            let j_total=j_vals.contest1+j_vals.contest2+j_vals.contest3;
                            let name=juryNames[j_id]||`Жюри ${j_id}`;
                            let div=document.createElement('div'); div.className='jury-score';
                            div.innerHTML=`<strong>${name}:</strong> ${j_total}${j_vals.finalized?' <span class="finalized-text">✓</span>':''}`;
                            allScores.appendChild(div);
                        }
                    }
                }
            }
        }
    }
}

function updateScore(participantId,juryId,contest,value){
    if(value<0||value>5){alert('Балл должен быть от 0 до 5');return;}
    fetch('/update_score',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({participant_id:participantId,jury_id:juryId,contest:contest,score:value})})
    .then(r=>r.json()).then(d=>{if(d.success) updateDisplay(participantId,juryId); else if(d.error) alert(d.error);}).catch(e=>console.error(e));
}

function finalizeScores(participantId,juryId){
    if(confirm('Вы уверены, что хотите финализировать оценки? После этого их нельзя будет изменить.')){
        fetch('/finalize_scores',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({participant_id:participantId,jury_id:juryId})})
        .then(r=>r.json()).then(d=>{
            if(d.success){
                document.querySelectorAll(`#inputs-${participantId}-${juryId} .score-input`).forEach(i=>i.disabled=true);
                const finalize=document.getElementById(`finalize-${participantId}-${juryId}`);
                finalize.innerHTML='<span class="finalized-text">✓ Финализировано</span>';
            }
        }).catch(e=>console.error(e));
    }
}

function updateDisplay(participantId,juryId){
    const inputs=document.querySelectorAll(`#cell-${participantId}-${juryId} .score-input`);
    const display=document.getElementById(`display-${participantId}-${juryId}`);
    if(display){
        const c1=inputs[0].value, c2=inputs[1].value, c3=inputs[2].value;
        display.textContent=`${c1}+${c2}+${c3}`;
    }
}

document.addEventListener('DOMContentLoaded',()=>{
    document.querySelectorAll('.score-input').forEach(input=>{
        input.addEventListener('change',()=>updateScore(input.dataset.participant,input.dataset.jury,input.dataset.contest,input.value));
    });
    document.querySelectorAll('.finalize-btn').forEach(btn=>{
        btn.addEventListener('click',()=>finalizeScores(btn.dataset.participant,btn.dataset.jury));
    });
});
</script>
</body>
</html>
