<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>RKSIBET — Панель Жюри</title>
<style>
  body {
    margin:0; padding:0; font-family:'Courier New', monospace;
    background:#0a0a0a; color:#0ff;
    display:flex; flex-direction:column; min-height:100vh;
  }
  header {
    background:#111;
    padding:15px 30px;
    font-size:1.5em;
    display:flex; justify-content:space-between; align-items:center;
    text-shadow:0 0 10px #0ff;
  }
  header a {color:#ff3366; text-decoration:none; transition:0.3s;}
  header a:hover {text-shadow:0 0 10px #ff3366;}

  .container {
    flex:1;
    display:flex;
    padding:20px;
    gap:20px;
  }
  .sidebar {
    width:280px;
    background:#111;
    padding:20px;
    border:1px solid #0ff;
    border-radius:10px;
    box-shadow:0 0 20px rgba(0,255,255,0.2);
  }
  .sidebar h3 {margin-top:0; text-shadow:0 0 5px #0ff;}
  .instructions {
    font-size:13px; line-height:1.5;
    background:#000a; padding:15px; border-radius:8px;
    border:1px solid #0ff;
    box-shadow:0 0 10px rgba(0,255,255,0.2);
  }

  .main {
    flex:1; overflow:auto;
  }
  table {
    width:100%; border-collapse:collapse;
    table-layout:fixed;
  }
  th,td {
    border:1px solid #0ff; padding:5px; text-align:center;
    position:relative;
    transition:0.3s all;
  }
  th {
    background:#111;
    color:#0ff;
    font-weight:bold;
    text-shadow:0 0 5px #0ff;
  }

  /* Колонка текущего жюри */
  .my-column {background:#001a00 !important; border:2px solid #00ff66 !important;}

  /* Inputs */
  .score-inputs {display:flex; gap:5px; justify-content:center; margin-bottom:5px;}
  .score-input {
    width:35px; padding:4px; background:#111; border:1px solid #0ff; color:#0ff; text-align:center;
    border-radius:5px; transition:0.3s;
  }
  .score-input:focus {outline:none; box-shadow:0 0 10px #0ff;}

  /* Финализировано */
  .finalize-btn {
    background:#ff3366; color:#000; font-weight:bold; border:none; border-radius:5px;
    padding:5px 10px; cursor:pointer; transition:0.3s;
  }
  .finalize-btn:hover {background:#ff66aa; transform:scale(1.05);}
  .finalized-text {color:#00ff66; font-weight:bold;}

  /* Подсветка */
  .highlight {animation: highlight 0.5s ease;}
  @keyframes highlight {0%{background:#0ff;color:#000;} 100%{background:#111;color:#0ff;}}

  /* Итоги */
  .total-score {font-weight:bold; color:#0ff; margin-top:3px;}
  .participant-scores {font-size:12px; line-height:1.4; text-align:left;}
  .jury-score {margin:2px 0; padding:2px; background:#111; border-radius:3px;}
</style>
</head>
<body>
<header>
  <div>Жюри: {{ jury.name }}</div>
  <a href="{{ url_for('home') }}">[Выход]</a>
</header>

<div class="container">
<div class="sidebar">
  <h3>Инструкция</h3>
  <div class="instructions">
    <p>Вы можете редактировать только свою колонку (зеленым выделена).</p>
    <p><strong>Важно:</strong> После выставления баллов нажмите "Финализировать". Изменить будет нельзя!</p>
    <p>Следите за суммой ваших баллов и за обновлениями в реальном времени.</p>
  </div>
  <h3 style="margin-top:20px;"><a href="{{ url_for('leaderboard') }}">Перейти к Лидерборду</a></h3>
</div>

<div class="main">
<h3>Оценки участников</h3>
<table id="score-table">
<tr>
  <th>Участник</th>
  {% for j in jury_list %}
    <th class="{% if j.id == jury.id %}my-column{% endif %}">{{ j.name }}</th>
  {% endfor %}
  <th>Сумма</th>
</tr>

{% for p in participants %}
<tr id="row-{{ p.id }}">
  <td>{{ p.name }}</td>
  {% for j in jury_list %}
  <td id="cell-{{ p.id }}-{{ j.id }}" class="{% if j.id == jury.id %}my-column{% endif %}">
    {% if j.id == jury.id %}
      <div class="score-inputs" id="inputs-{{ p.id }}-{{ j.id }}">
        <input type="number" min="0" max="5" value="{{ scores[p.id][j.id]['contest1'] }}"
               class="score-input" data-participant="{{ p.id }}" data-jury="{{ j.id }}" data-contest="contest1"
               {% if scores[p.id][j.id]['finalized'] %}disabled{% endif %}>
        <input type="number" min="0" max="5" value="{{ scores[p.id][j.id]['contest2'] }}"
               class="score-input" data-participant="{{ p.id }}" data-jury="{{ j.id }}" data-contest="contest2"
               {% if scores[p.id][j.id]['finalized'] %}disabled{% endif %}>
        <input type="number" min="0" max="5" value="{{ scores[p.id][j.id]['contest3'] }}"
               class="score-input" data-participant="{{ p.id }}" data-jury="{{ j.id }}" data-contest="contest3"
               {% if scores[p.id][j.id]['finalized'] %}disabled{% endif %}>
      </div>
      <div class="total-score" id="display-{{ p.id }}-{{ j.id }}">
        {{ scores[p.id][j.id]['contest1'] }}+{{ scores[p.id][j.id]['contest2'] }}+{{ scores[p.id][j.id]['contest3'] }}
      </div>
      <div class="finalize-section" id="finalize-{{ p.id }}-{{ j.id }}">
        {% if not scores[p.id][j.id]['finalized'] %}
        <button class="finalize-btn" data-participant="{{ p.id }}" data-jury="{{ j.id }}">Финализировать</button>
        {% else %}
        <span class="finalized-text">✓ Финализировано</span>
        {% endif %}
      </div>
    {% else %}
      <div class="jury-score">
        <div>Конкурс 1: {{ scores[p.id][j.id]['contest1'] }} баллов</div>
        <div>Конкурс 2: {{ scores[p.id][j.id]['contest2'] }} баллов</div>
        <div>Конкурс 3: {{ scores[p.id][j.id]['contest3'] }} баллов</div>
        <div class="total-score">Сумма: {{ scores[p.id][j.id]['contest1'] + scores[p.id][j.id]['contest2'] + scores[p.id][j.id]['contest3'] }}</div>
      </div>
    {% endif %}
  </td>
  {% endfor %}

  <td id="total-{{ p.id }}">
    <div class="participant-scores">
      <div class="total-score">Общая сумма: {{ totals[p.id] }}</div>
      {% set my_total = scores[p.id][jury.id]['contest1'] + scores[p.id][jury.id]['contest2'] + scores[p.id][jury.id]['contest3'] %}
      {% if my_total > 0 %}
      <div class="my-total">Мои баллы: {{ my_total }}</div>
      {% endif %}
      <div class="all-scores">
        {% for j in jury_list %}
        <div class="jury-score"><strong>{{ j.name }}:</strong>
          {{ scores[p.id][j.id]['contest1'] + scores[p.id][j.id]['contest2'] + scores[p.id][j.id]['contest3'] }}
          {% if scores[p.id][j.id]['finalized'] %}<span class="finalized-text">✓</span>{% endif %}
        </div>
        {% endfor %}
      </div>
    </div>
  </td>
</tr>
{% endfor %}
</table>
</div>
</div>

<script>
let ws;
function connectWebSocket() {
    ws = new WebSocket("ws://"+location.host+"/ws");

    ws.onopen = ()=>console.log("WebSocket connected");
    ws.onclose = ()=>setTimeout(connectWebSocket,1000);
    ws.onerror = (e)=>console.log("WebSocket error:",e);
    ws.onmessage = handleMessage;
}
connectWebSocket();

function handleMessage(event){
    let data=JSON.parse(event.data);
    if(data.type==='score_update'){
        for(let p_id in data.scores){
            for(let j_id in data.scores[p_id]){
                let cell=document.getElementById(`cell-${p_id}-${j_id}`);
                if(cell){
                    let vals=data.scores[p_id][j_id];
                    let total=vals.contest1+vals.contest2+vals.contest3;

                    if(cell.classList.contains('my-column')){
                        let inputs = cell.querySelectorAll('.score-input');
                        if(inputs.length>=3){
                            inputs[0].value=vals.contest1;
                            inputs[1].value=vals.contest2;
                            inputs[2].value=vals.contest3;
                            if(vals.finalized){
                                inputs.forEach(i=>i.disabled=true);
                                let finalize=document.getElementById(`finalize-${p_id}-${j_id}`);
                                if(finalize) finalize.innerHTML='<span class="finalized-text">✓ Финализировано</span>';
                            }
                        }
                        let display=document.getElementById(`display-${p_id}-${j_id}`);
                        if(display){display.textContent=`${vals.contest1}+${vals.contest2}+${vals.contest3}`; display.classList.add('highlight'); setTimeout(()=>display.classList.remove('highlight'),500);}
                    } else {
                        cell.innerHTML=`
                          <div class="jury-score">
                            <div>Конкурс 1: ${vals.contest1} баллов</div>
                            <div>Конкурс 2: ${vals.contest2} баллов</div>
                            <div>Конкурс 3: ${vals.contest3} баллов</div>
                            <div class="total-score">Сумма: ${total}</div>
                          </div>`;
                        cell.classList.add('highlight'); setTimeout(()=>cell.classList.remove('highlight'),500);
                    }
                }
            }
            let totalCell=document.getElementById(`total-${p_id}`);
            if(totalCell){
                let part=totalCell.querySelector('.participant-scores');
                if(part){
                    let totalSum=part.querySelector('.total-score');
                    if(totalSum) totalSum.textContent=`Общая сумма: ${data.totals[p_id]}`;
                    let allScores=part.querySelector('.all-scores');
                    if(allScores){
                        allScores.innerHTML='';
                        let juryNames={};
                        if(data.jury_list) data.jury_list.forEach(j=>juryNames[j.id]=j.name);
                        for(let j_id in data.scores[p_id]){
                            let j_vals=data.scores[p_id][j_id];
                            let j_total=j_vals.contest1+j_vals.contest2+j_vals.contest3;
                            let name=juryNames[j_id]||`Жюри ${j_id}`;
                            let div=document.createElement('div'); div.className='jury-score';
                            div.innerHTML=`<strong>${name}:</strong> ${j_total}${j_vals.finalized?' <span class="finalized-text">✓</span>':''}`;
                            allScores.appendChild(div);
                        }
                    }
                }
            }
        }
    }
}

function updateScore(participantId,juryId,contest,value){
    if(value<0||value>5){alert('Балл должен быть от 0 до 5');return;}
    fetch('/update_score',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({participant_id:participantId,jury_id:juryId,contest:contest,score:value})})
    .then(r=>r.json()).then(d=>{if(d.success) updateDisplay(participantId,juryId); else if(d.error) alert(d.error);}).catch(e=>console.error(e));
}

function finalizeScores(participantId,juryId){
    if(confirm('Вы уверены, что хотите финализировать оценки? После этого их нельзя будет изменить.')){
        fetch('/finalize_scores',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({participant_id:participantId,jury_id:juryId})})
        .then(r=>r.json()).then(d=>{
            if(d.success){
                document.querySelectorAll(`#inputs-${participantId}-${juryId} .score-input`).forEach(i=>i.disabled=true);
                const finalize=document.getElementById(`finalize-${participantId}-${juryId}`);
                finalize.innerHTML='<span class="finalized-text">✓ Финализировано</span>';
            }
        }).catch(e=>console.error(e));
    }
}

function updateDisplay(participantId,juryId){
    const inputs=document.querySelectorAll(`#cell-${participantId}-${juryId} .score-input`);
    const display=document.getElementById(`display-${participantId}-${juryId}`);
    if(display){
        const c1=inputs[0].value, c2=inputs[1].value, c3=inputs[2].value;
        display.textContent=`${c1}+${c2}+${c3}`;
    }
}

document.addEventListener('DOMContentLoaded',()=>{
    document.querySelectorAll('.score-input').forEach(input=>{
        input.addEventListener('change',()=>updateScore(input.dataset.participant,input.dataset.jury,input.dataset.contest,input.value));
    });
    document.querySelectorAll('.finalize-btn').forEach(btn=>{
        btn.addEventListener('click',()=>finalizeScores(btn.dataset.participant,btn.dataset.jury));
    });
});
</script>
</body>
</html>
