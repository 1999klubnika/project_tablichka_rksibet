<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>RKSIBET ‚Äî –õ–∏–¥–µ—Ä–±–æ—Ä–¥</title>
<link rel="stylesheet" href="{{ url_for('static', filename='css/leaderboard.css') }}">

</head>
<body>

<a id="viewer-btn" href="{{ url_for('viewer') }}">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –æ—Ü–µ–Ω–∫–∞–º</a>

<div id="dvd-logo"></div>

<h1 id="banner">–õ–∏–¥–µ—Ä–±–æ—Ä–¥ RKSIBET</h1>

<table id="leaderboard">
<tr>
    <th>–ú–µ—Å—Ç–æ</th>
    <th>–£—á–∞—Å—Ç–Ω–∏–∫</th>
    <th>–ë–∞–ª–ª—ã</th>
</tr>
{% for l in leaderboard %}
<tr id="lb-{{ l.name }}">
    <td>
        {% if loop.index == 1 %}<span class="medal">ü•á</span>
        {% elif loop.index == 2 %}<span class="medal">ü•à</span>
        {% elif loop.index == 3 %}<span class="medal">ü•â</span>
        {% else %}{{ loop.index }}
        {% endif %}
    </td>
    <td>{{ l.name }}</td>
    <td>{{ l.total }}</td>
</tr>
{% endfor %}
</table>

<script>
let ws;
function connectWebSocket() {
    ws = new WebSocket("ws://"+location.host+"/ws");
    
    ws.onopen = () => console.log("WebSocket connected");
    ws.onclose = () => {
        console.log("WebSocket disconnected, reconnecting...");
        setTimeout(connectWebSocket, 1000);
    };
    ws.onerror = (err) => console.log("WebSocket error:", err);
    ws.onmessage = handleMessage;
}
connectWebSocket();

function handleMessage(event) {
    let data = JSON.parse(event.data);
    if(data.type === 'score_update'){
        // –ü–æ–ª—É—á–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –∏ –æ—á–∏—â–∞–µ–º –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ –∫—Ä–æ–º–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞
        let table = document.getElementById('leaderboard');
        while (table.rows.length > 1) {
            table.deleteRow(1);  // –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏ –Ω–∞—á–∏–Ω–∞—è —Å–æ –≤—Ç–æ—Ä–æ–π (–∏–Ω–¥–µ–∫—Å 1)
        }

        // –ü–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ leaderboard
        data.leaderboard.forEach((l, i) => {
            let row = table.insertRow();  // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É
            row.id = `lb-${l.name}`;  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º ID –¥–ª—è –≤–æ–∑–º–æ–∂–Ω—ã—Ö –±—É–¥—É—â–∏—Ö —Å—Å—ã–ª–æ–∫

            // –Ø—á–µ–π–∫–∞ —Å –º–µ—Å—Ç–æ–º/–º–µ–¥–∞–ª—å—é
            let placeCell = row.insertCell(0);
            let medal = '';
            if (i === 0) medal = '<span class="medal">ü•á</span>';
            else if (i === 1) medal = '<span class="medal">ü•à</span>';
            else if (i === 2) medal = '<span class="medal">ü•â</span>';
            else medal = (i + 1).toString();
            placeCell.innerHTML = medal;

            // –Ø—á–µ–π–∫–∞ —Å –∏–º–µ–Ω–µ–º
            let nameCell = row.insertCell(1);
            nameCell.textContent = l.name;

            // –Ø—á–µ–π–∫–∞ —Å –±–∞–ª–ª–∞–º–∏
            let totalCell = row.insertCell(2);
            totalCell.textContent = l.total;

            // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–æ–¥—Å–≤–µ—Ç–∫–∏
            row.classList.add('highlight');
            setTimeout(() => row.classList.remove('highlight'), 700);
        });
    }
}
</script>
</body>
</html>