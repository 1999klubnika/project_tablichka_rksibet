<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ó—Ä–∏—Ç–µ–ª—å</title>
<style>
body {background:#0b0b0b; color:#0ff; font-family:'Courier New', monospace; margin:0; padding:0;}
h1 {text-align:center; margin:10px;}
.container {display:flex;}
.sidebar {width:250px; background:#111; padding:10px; overflow-y:auto;}
.main {flex:1; padding:10px; overflow:auto;}
table {width:100%; border-collapse:collapse;}
th,td {border:1px solid #0ff; padding:5px; text-align:center;}
th {background:#222;}
.highlight {animation: highlight 0.5s ease;}
@keyframes highlight {0%{background:#0ff;color:#000;} 100%{background:#111;color:#0ff;}}
.score-breakdown {font-size:12px; line-height:1.3;}
.score-breakdown div {margin:2px 0;}
.total-score {font-weight:bold; color:#0ff; border-top:1px solid #0ff; padding-top:2px; margin-top:4px;}
</style>
</head>
<body>
<h1>–ó—Ä–∏—Ç–µ–ª—å</h1>
<div class="container">
<div class="sidebar">
<h3>–õ–∏–¥–µ—Ä–±–æ—Ä–¥</h3>
<table id="leaderboard">
<tr><th>–ú–µ—Å—Ç–æ</th><th>–£—á–∞—Å—Ç–Ω–∏–∫</th><th>–ë–∞–ª–ª—ã</th></tr>
{% for l in leaderboard %}
<tr id="lb-{{ l.name }}">
  <td>
    {% if loop.index == 1 %}ü•á
    {% elif loop.index == 2 %}ü•à
    {% elif loop.index == 3 %}ü•â
    {% else %}{{ loop.index }}
    {% endif %}
  </td>
  <td>{{ l.name }}</td>
  <td>{{ l.total }}</td>
</tr>
{% endfor %}
</table>
</div>

<div class="main">
<h3>–û—Ü–µ–Ω–∫–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</h3>
<table id="score-table">
<tr>
<th>–£—á–∞—Å—Ç–Ω–∏–∫</th>
{% for j in jury_list %}<th>{{ j.name }}</th>{% endfor %}
<th>–°—É–º–º–∞</th>
</tr>
{% for p in participants %}
<tr id="row-{{ p.id }}">
<td>{{ p.name }}</td>
{% for j in jury_list %}
<td id="cell-{{p.id}}-{{j.id}}">
  <div class="score-breakdown">
    <div>–ö–æ–Ω–∫—É—Ä—Å 1: {{ scores[p.id][j.id]['contest1'] }} –±–∞–ª–ª–æ–≤</div>
    <div>–ö–æ–Ω–∫—É—Ä—Å 2: {{ scores[p.id][j.id]['contest2'] }} –±–∞–ª–ª–æ–≤</div>
    <div>–ö–æ–Ω–∫—É—Ä—Å 3: {{ scores[p.id][j.id]['contest3'] }} –±–∞–ª–ª–æ–≤</div>
    <div class="total-score">–°—É–º–º–∞: {{ scores[p.id][j.id]['contest1'] + scores[p.id][j.id]['contest2'] + scores[p.id][j.id]['contest3'] }}</div>
  </div>
</td>
{% endfor %}
<td id="total-{{ p.id }}">{{ totals[p.id] }}</td>
</tr>
{% endfor %}
</table>
</div>
</div>

<script>
let ws;
function connectWebSocket() {
    ws = new WebSocket("ws://"+location.host+"/ws");
    
    ws.onopen = function() {
        console.log("WebSocket connected");
    };
    
    ws.onclose = function() {
        console.log("WebSocket disconnected, reconnecting...");
        setTimeout(connectWebSocket, 1000);
    };
    
    ws.onerror = function(error) {
        console.log("WebSocket error:", error);
    };
    
    ws.onmessage = handleMessage;
}

connectWebSocket();

function handleMessage(event) {
    console.log('Received message:', event.data);
    let data=JSON.parse(event.data);
    if(data.type==='score_update'){
        console.log('Updating scores:', data.scores);
        for(let p_id in data.scores){
            for(let j_id in data.scores[p_id]){
                let cell=document.getElementById(`cell-${p_id}-${j_id}`);
                if(cell){
                    let vals=data.scores[p_id][j_id];
                    let total = vals.contest1 + vals.contest2 + vals.contest3;
                    cell.innerHTML = `
                        <div class="score-breakdown">
                            <div>–ö–æ–Ω–∫—É—Ä—Å 1: ${vals.contest1} –±–∞–ª–ª–æ–≤</div>
                            <div>–ö–æ–Ω–∫—É—Ä—Å 2: ${vals.contest2} –±–∞–ª–ª–æ–≤</div>
                            <div>–ö–æ–Ω–∫—É—Ä—Å 3: ${vals.contest3} –±–∞–ª–ª–æ–≤</div>
                            <div class="total-score">–°—É–º–º–∞: ${total}</div>
                        </div>
                    `;
                    cell.classList.add('highlight');
                    setTimeout(()=>cell.classList.remove('highlight'),500);
                }
            }
            let totalCell=document.getElementById(`total-${p_id}`);
            if(totalCell) totalCell.innerText=data.totals[p_id];
        }
        // –õ–∏–¥–µ—Ä–±–æ—Ä–¥
        for(let i=0;i<data.leaderboard.length;i++){
            let l=data.leaderboard[i];
            let row=document.getElementById(`lb-${l.name}`);
            if(row) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Å—Ç–æ (–ø–µ—Ä–≤–∞—è —è—á–µ–π–∫–∞)
                let medal = '';
                if(i === 0) medal = 'ü•á';
                else if(i === 1) medal = 'ü•à';
                else if(i === 2) medal = 'ü•â';
                else medal = (i + 1).toString();
                row.cells[0].innerText = medal;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–ª—ã (—Ç—Ä–µ—Ç—å—è —è—á–µ–π–∫–∞, —Ç–∞–∫ –∫–∞–∫ —Ç–µ–ø–µ—Ä—å —É –Ω–∞—Å 3 –∫–æ–ª–æ–Ω–∫–∏)
                row.cells[2].innerText = l.total;
            }
        }
    }
};
</script>
</body>
</html>
