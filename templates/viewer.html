<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>RKSIBET — Оценки участников</title>
<link rel="stylesheet" href="{{ url_for('static', filename='css/viewer.css') }}">
</head>
<body>

<a id="leaderboard-btn" href="{{ url_for('leaderboard') }}">Перейти к Лидерборду</a>
<a id="home-btn" href="{{ url_for('home') }}">На главную</a>

<h1 id="banner">Оценки участников RKSIBET</h1>

<table id="score-table">
<tr>
    <th>Участник</th>
    {% for j in jury_list %}
    <th>{{ j.name }}</th>
    {% endfor %}
</tr>
{% for p in participants %}
<tr id="row-{{ p.id }}">
    <td>{{ p.name }}</td>
    {% for j in jury_list %}
    <td id="cell-{{ p.id }}-{{ j.id }}" data-jury="{{ j.name }}">
        <div>
            <span class="score-{{ scores[p.id][j.id]['contest1'] }}">{{ scores[p.id][j.id]['contest1'] }}</span> /
            <span class="score-{{ scores[p.id][j.id]['contest2'] }}">{{ scores[p.id][j.id]['contest2'] }}</span> /
            <span class="score-{{ scores[p.id][j.id]['contest3'] }}">{{ scores[p.id][j.id]['contest3'] }}</span>
        </div>
    </td>
    {% endfor %}
</tr>
{% endfor %}
</table>

<script>
let ws;
function connectWebSocket() {
    ws = new WebSocket("ws://"+location.host+"/ws");
    
    ws.onopen = () => console.log("WebSocket connected");
    ws.onclose = () => setTimeout(connectWebSocket, 1000);
    ws.onerror = (err) => console.log("WebSocket error:", err);
    ws.onmessage = handleMessage;
}
connectWebSocket();

function handleMessage(event) {
    let data = JSON.parse(event.data);
    if(data.type === 'score_update'){
        for(let p_id in data.scores){
            for(let j_id in data.scores[p_id]){
                let cell = document.getElementById(`cell-${p_id}-${j_id}`);
                if(cell){
                    let vals = data.scores[p_id][j_id];
                    cell.innerHTML = `
                        <div>
                            <span class="score-${vals.contest1}">${vals.contest1}</span> /
                            <span class="score-${vals.contest2}">${vals.contest2}</span> /
                            <span class="score-${vals.contest3}">${vals.contest3}</span>
                        </div>
                    `;
                    cell.classList.add('highlight');
                    setTimeout(()=>cell.classList.remove('highlight'),700);
                }
            }
        }
    }
}
</script>

</body>
</html>